---
title: "Putting it all Together"
teaching: 5
exercises: 120
---

:::::::::::::::::::::::::::::::::::::: questions 

- How do I put the whole spatial transcriptomics analysis together?

::::::::::::::::::::::::::::::::::::::::::::::::

::::::::::::::::::::::::::::::::::::: objectives

- Understand the steps in spatial transcriptomics analysis.
- Perform a spatial transcriptomics analysis on another sample.

::::::::::::::::::::::::::::::::::::::::::::::::

## Introduction

Over the past day and a half, we have reviewed the steps in a spatial 
transcriptomics analysis. There were many steps and many lines of code. In this
final lesson, you will run through the spatial transcriptomics analysis on
your own with another sample.

::::::::::::::::::::::::::::::::::::: challenge 

### Challenge 1: Reading in a new sample.

Look back through the lessons. What libraries did we use? Load those in now.

:::::::::::::::::::::::: solution 
 
```{r}
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(Seurat))
```


:::::::::::::::::::::::::::::::::



::::::::::::::::::::::::::::::::::::: challenge 

### Challenge 2: Reading in a new sample.

The publication which used this data has several tissue sections. As part of 
the setup, you should have downloaded sample 151508. Read in the filtered 
sample file for this sample.

:::::::::::::::::::::::: solution 
 
```{r}
st_obj <- Load10X_Spatial(data.dir  = "./data/151508", 
                          filename  = "151508_raw_feature_bc_matrix.h5")
```


:::::::::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::: challenge 

### Challenge 3: Reading in sample metadata.

In the Data Preprocessing lesson, we showed you how to read in sample metadata
and add it to the Seurat object. Find that code and add the new sample's 
metadata to your Seurat object.

:::::::::::::::::::::::: solution 
 
```{r}
# Read in the tissue spot positions.
tissue_position <- read_csv("./data/151508/spatial/tissue_positions_list.csv",
                            col_names = FALSE, show_col_types = FALSE) %>% 
                     column_to_rownames('X1')
colnames(tissue_position) <- c("in_tissue", 
                               "array_row", 
                               "array_col", 
                               "pxl_row_in_fullres", 
                               "pxl_col_in_fullres")

# Align the spot barcodes to match between the Seurat object and the new
# metadata.
tissue_position <- tissue_position[Cells(st_obj),]
stopifnot(rownames(tissue_position) == Cells(st_obj))

# Add the metadata to the Seurat object.
st_obj <- AddMetaData(object = st_obj, metadata = tissue_position)
```

:::::::::::::::::::::::::::::::::


::::::::::::::::::::::::::::::::::::: challenge 

### Challenge 4: Plot the spot positions over the tissue section.

Look for the code to plot the number of counts in each spot in the Data 
Preprocessing lesson and adapt it to your tissue sample.

:::::::::::::::::::::::: solution 
 
```{r}
SpatialFeaturePlot(st_obj, features = "nCount_Spatial")
```

:::::::::::::::::::::::::::::::::












<!-- DMG: examples below -->

:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::: instructor

Inline instructor notes can help inform instructors of timing challenges
associated with the lessons. They appear in the "Instructor View"

::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::

### Code fences

Code fences written in standard markdown format will be highlighted, but not
evaluated:

```bash
echo '47 + 2' | bc
echo '47 * 2' | bc
```

Code fences written using R Markdown chunk notation will be highlighted and 
executed:

```{r}
magic <- sprintf("47 plus 2 equals %d\n47 times 2 equals %d", 47 + 2, 47 * 2) 
cat(magic)
```

It's magic!

::::::::::::::::::::::::::::::::::::: challenge 

### Challenge 1: Can you do it?

What is the output of this command?

```r
paste("This", "new", "lesson", "looks", "good")
```

:::::::::::::::::::::::: solution 

### Output
 
```output
[1] "This new lesson looks good"
```

:::::::::::::::::::::::::::::::::


### Challenge 2: how do you nest solutions within challenge blocks?

:::::::::::::::::::::::: solution 

You can add a line with at least three colons and a `solution` tag.

:::::::::::::::::::::::::::::::::
::::::::::::::::::::::::::::::::::::::::::::::::

## Figures

You can also include figures generated from R Markdown:

```{r pyramid, fig.alt = "pie chart illusion of a pyramid", fig.cap = "Sun arise each and every morning"}
pie(
  c(Sky = 78, "Sunny side of pyramid" = 17, "Shady side of pyramid" = 5), 
  init.angle = 315, 
  col = c("deepskyblue", "yellow", "yellow3"), 
  border = FALSE
)
```

Or you can use standard markdown for static figures with the following syntax:

`![optional caption that appears below the figure](figure url){alt='alt text for
accessibility purposes'}`

For example:

`![You belong in The Carpentries!](fig/Badge_Carpentries.svg){alt='Blue Carpentries hex person logo with no text.'}`

![You belong in The Carpentries!](fig/Badge_Carpentries.svg){alt='Blue Carpentries hex person logo with no text.'}

[Additional attributes can be specified for the image](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/Img#attributes)
alongside the alternative text description in the `{}`.
Some, like `width` and `height`, can be specified directly:

`![You belong in The Carpentries!](fig/Badge_Carpentries.svg){alt='Blue Carpentries hex person logo with no text.' width='25%'}`

![You belong in The Carpentries!](fig/Badge_Carpentries.svg){alt='Blue Carpentries hex person logo with no text.' width='25%'}

:::::::::::: callout

## :art: Advanced Image Styling

More complex styling with arbitrary CSS is also possible within the Workbench,
by providing CSS directives (separated by `;`) to a `style` attribute inside the `{}`.

However, you should be aware that _all styling must be described in this `style` attribute
if it is present_, i.e. `width` and `height` must be included as CSS directives
_within the `style` attribute_ when it is used.

For example, to introduce some padding around the resized image:

`![You belong in The Carpentries!](fig/Badge_Carpentries.svg){alt='Blue Carpentries hex person logo with no text.' style='padding:10px; width:25%'}`

![You belong in The Carpentries!](fig/Badge_Carpentries.svg){alt='Blue Carpentries hex person logo with no text.' style='padding:10px; width:25%'}

Note the use of `:` for the key-value pairs of CSS directives defined within `style`.

::::::::::::::::::::


## Math

One of our episodes contains $\LaTeX$ equations when describing how to create
dynamic reports with {knitr}, so we now use mathjax to describe this:

`$\alpha = \dfrac{1}{(1 - \beta)^2}$` becomes: $\alpha = \dfrac{1}{(1 - \beta)^2}$

Cool, right?

::::::::::::::::::::::::::::::::::::: keypoints 

- Use `.md` files for episodes when you want static content
- Use `.Rmd` files for episodes when you need to generate output
- Run `sandpaper::check_lesson()` to identify any issues with your lesson
- Run `sandpaper::build_lesson()` to preview your lesson locally

::::::::::::::::::::::::::::::::::::::::::::::::

